<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Five Forks Fire Weather</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body data-theme="light">
    <div class="container">
        <!-- Header with Title and Controls -->
        <header>
            <div class="location-info">
                <h1>Five Forks</h1>
                <p class="subtitle">Virginia Fire Weather</p>
            </div>
            <div class="header-controls">
                <button class="icon-btn" id="themeToggle" aria-label="Toggle day/night mode" title="Toggle theme">üåó</button>
                <button class="icon-btn" id="refreshBtn" aria-label="Refresh data" title="Refresh">üîÑ</button>
            </div>
        </header>

        <!-- Quick Links Bar -->
        <div class="quick-links">
            <a href="https://firms.modaps.eosdis.nasa.gov/map/" target="_blank" class="link-btn">
                <span class="link-icon">üõ∞Ô∏è</span>
                <span class="link-label">FIRMS</span>
            </a>
            <a href="https://www.weather.gov/akq/" target="_blank" class="link-btn">
                <span class="link-icon">üåßÔ∏è</span>
                <span class="link-label">NWS</span>
            </a>
            <a href="https://maps.app.goo.gl/vcWebUQrrLSY8gX4A" target="_blank" class="link-btn">
                <span class="link-icon">üó∫Ô∏è</span>
                <span class="link-label">Equip</span>
            </a>
            <a href="https://www.windy.com/?37.233,-77.400,8" target="_blank" class="link-btn">
                <span class="link-icon">üå™Ô∏è</span>
                <span class="link-label">Windy</span>
            </a>
        </div>

        <!-- County Cards Section -->
        <section class="counties-section">
            <h2>County Conditions</h2>
            <div class="county-grid" id="countyGrid">
               <head>
  <meta charset="UTF-8">
  <title>Fire Weather Forecast ‚Äì Virginia Fall Fire Season</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background: #222;
      color: #eee;
      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
      margin: 0; padding: 0;
    }
    header {
      background: #2d2d2d;
      padding: 1.5rem 1rem 1rem 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    }
    h1 {
      font-size: 2rem; margin: 0;
      font-weight: 700; color: #fff;
      letter-spacing: 1px;
    }
    h2 {
      font-size: 1.5rem;
      margin: 2rem 0 1rem 0;
      color: #fff;
    }
    .back-link {
      display: inline-block;
      margin-top: 1rem;
      color: #4caf50;
      text-decoration: none;
      font-weight: bold;
      font-size: 1.1rem;
    }
    .back-link:hover {
      color: #81c784;
      text-decoration: underline;
    }
      // Five Forks Fire Weather Dashboard - Main Script

// County data with centroids for NWS API
const COUNTIES = [
    { name: 'Dinwiddie', lat: 37.0751, lon: -77.5831 },
    { name: 'Brunswick', lat: 36.7168, lon: -77.8500 },
    { name: 'Greensville', lat: 36.6835, lon: -77.5664 },
    { name: 'Amelia', lat: 37.3500, lon: -77.9700 },
    { name: 'Prince George', lat: 37.1835, lon: -77.2831 },
    { name: 'Nottoway', lat: 37.1000, lon: -78.0700 }
];

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', function() {
    initTheme();
    initMap();
    loadCountyData();

    // Event listeners
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    document.getElementById('refreshBtn').addEventListener('click', refreshData);
});

// Theme Management
function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
}

function toggleTheme() {
    const currentTheme = document.body.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
}

// Map Initialization
let map;
// Layer group for county markers on the map. Defined after map initialization.
let countyLayerGroup;
function initMap() {
    map = L.map('map').setView([37.2, -77.7], 8);

    // Light basemap for fire visibility
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CartoDB',
        maxZoom: 19
    }).addTo(map);

    // Create a layer group to hold county markers. This will be cleared on each data refresh.
    countyLayerGroup = L.layerGroup().addTo(map);
}

// Placeholder removed: the FIRMS fire hotspot layer has been replaced by NWS data.
// County markers will be generated from the National Weather Service API via addCountyMarkers().

/**
 * Fetch current fire weather metrics for a given county using the National Weather Service API.
 * This function calls the `points` endpoint to resolve the nearest gridpoint and then
 * retrieves the first period of the hourly forecast. It returns an object with
 * temperature (F), relative humidity (%), dew point (F), wind speed (mph), gust (mph) and danger class.
 * On failure, the caller is responsible for providing fallback values.
 * 
 * @param {Object} county - County descriptor with `name`, `lat` and `lon` properties.
 * @returns {Promise<Object>} An object containing weather metrics and the county name and coordinates.
 */
async function fetchCountyWeather(county) {
    // Resolve the gridpoint for this coordinate
    const pointsUrl = `https://api.weather.gov/points/${county.lat},${county.lon}`;
    const pointsResp = await fetch(pointsUrl);
    if (!pointsResp.ok) {
        throw new Error(`Failed to fetch points for ${county.name}: ${pointsResp.status}`);
    }
    const pointsData = await pointsResp.json();
    const gridId = pointsData.properties.gridId;
    const gridX = pointsData.properties.gridX;
    const gridY = pointsData.properties.gridY;
    if (!gridId || gridX === undefined || gridY === undefined) {
        throw new Error(`Invalid gridpoint data for ${county.name}`);
    }
    // Fetch hourly forecast for the gridpoint
    const hourlyUrl = `https://api.weather.gov/gridpoints/${gridId}/${gridX},${gridY}/forecast/hourly`;
    const hourlyResp = await fetch(hourlyUrl);
    if (!hourlyResp.ok) {
        throw new Error(`Failed to fetch hourly forecast for ${county.name}: ${hourlyResp.status}`);
    }
    const hourlyData = await hourlyResp.json();
    const periods = hourlyData.properties && hourlyData.properties.periods;
    if (!periods || periods.length === 0) {
        throw new Error(`No hourly forecast periods returned for ${county.name}`);
    }
    const firstPeriod = periods[0];
    // Extract metrics
    const temp = firstPeriod.temperature;
    const rh = firstPeriod.relativeHumidity && typeof firstPeriod.relativeHumidity.value === 'number'
        ? firstPeriod.relativeHumidity.value
        : null;
    const dewC = firstPeriod.dewpoint && typeof firstPeriod.dewpoint.value === 'number'
        ? firstPeriod.dewpoint.value
        : null;
    const dewF = dewC !== null ? Math.round((dewC * 9/5) + 32) : null;
    const windSpeedStr = firstPeriod.windSpeed || '';
    const windMatch = windSpeedStr.match(/\d+/);
    const wind = windMatch ? parseInt(windMatch[0], 10) : null;
    const windGustStr = firstPeriod.windGust || windSpeedStr;
    const gustMatch = windGustStr ? windGustStr.match(/\d+/) : null;
    const gust = gustMatch ? parseInt(gustMatch[0], 10) : wind;
    // Calculate danger class using existing scoring algorithm
    const dangerClass = calculateDangerClass(temp, rh, wind);
    return {
        name: county.name,
        temp: temp,
        rh: rh,
        dewPoint: dewF,
        wind: wind,
        gust: gust,
        dangerClass: dangerClass,
        lat: county.lat,
        lon: county.lon
    };
}

/**
 * Determine the color associated with a danger class. Colors are pulled from CSS custom properties
 * defined in the stylesheet. If a variable is missing, a reasonable fallback is used.
 * 
 * @param {number} dangerClass - Integer between 1 and 4 representing the fire danger level.
 * @returns {string} A CSS color string.
 */
function getDangerColor(dangerClass) {
    const rootStyles = getComputedStyle(document.documentElement);
    const varName = `--class-${dangerClass}-bg`;
    let color = rootStyles.getPropertyValue(varName).trim();
    if (!color) {
        // Fallback palette matching the README
        switch (dangerClass) {
            case 1: color = '#4ECDC4'; break;
            case 2: color = '#FFA726'; break;
            case 3: color = '#EF5350'; break;
            case 4: color = '#B71C1C'; break;
            default: color = '#4ECDC4';
        }
    }
    return color;
}

/**
 * Populate the map with markers for each county. The global countyLayerGroup will be cleared before adding new markers.
 * Each marker is a circle marker colored according to the county's danger class and displays a popup with details.
 * 
 * @param {Array<Object>} counties - Array of county weather objects produced by fetchCountyWeather().
 */
function addCountyMarkers(counties) {
    if (!countyLayerGroup) {
        countyLayerGroup = L.layerGroup().addTo(map);
    }
    countyLayerGroup.clearLayers();
    counties.forEach(county => {
        // Determine color for this danger class
        const fillColor = getDangerColor(county.dangerClass);
        const marker = L.circleMarker([county.lat, county.lon], {
            radius: 8,
            color: '#000',
            weight: 1,
            fillColor: fillColor,
            fillOpacity: 0.85
        });
        const popupContent = `
            <strong>${county.name} County</strong><br>
            Temp: ${county.temp ?? 'N/A'}¬∞F<br>
            RH: ${county.rh ?? 'N/A'}%<br>
            Dew Pt: ${county.dewPoint ?? 'N/A'}¬∞F<br>
            Wind: ${county.wind ?? 'N/A'} mph<br>
            Gust: ${county.gust ?? 'N/A'} mph<br>
            Danger: ${['Low','Moderate','High','Extreme'][Math.max(0, county.dangerClass - 1)]}
        `;
        marker.bindPopup(popupContent);
        marker.addTo(countyLayerGroup);
    });
}

// Load County Weather Data
async function loadCountyData() {
    const countyGrid = document.getElementById('countyGrid');
    countyGrid.innerHTML = '<div class="loading">Loading county data...</div>';

    // Build live data for each monitored county using the NWS API.
    const countiesData = [];
    for (const county of COUNTIES) {
        try {
            const data = await fetchCountyWeather(county);
            countiesData.push(data);
        } catch (error) {
            // On error fallback to demo values to avoid breaking the UI.
            console.error('Error fetching weather for', county.name, error);
            countiesData.push({
                name: county.name,
                temp: Math.floor(Math.random() * 20) + 65,
                rh: Math.floor(Math.random() * 40) + 20,
                dewPoint: Math.floor(Math.random() * 20) + 45,
                wind: Math.floor(Math.random() * 15) + 5,
                gust: Math.floor(Math.random() * 10) + 15,
                dangerClass: Math.floor(Math.random() * 4) + 1,
                lat: county.lat,
                lon: county.lon
            });
        }
    }
    // Render updated cards and update timestamp
    renderCountyCards(countiesData);
    updateTimestamp(new Date().toISOString());
    // Update map markers to reflect current danger levels
    addCountyMarkers(countiesData);
}

// Generate demo data (until backend is set up)
async function generateDemoData() {
    return COUNTIES.map(county => ({
        name: county.name,
        temp: Math.floor(Math.random() * 20) + 65,
        rh: Math.floor(Math.random() * 40) + 20,
        dewPoint: Math.floor(Math.random() * 20) + 45,
        wind: Math.floor(Math.random() * 15) + 5,
        gust: Math.floor(Math.random() * 10) + 15,
        // Danger class between 1 and 4 for demo data
        dangerClass: Math.floor(Math.random() * 4) + 1
    }));
}

// Calculate fire danger class from weather data
function calculateDangerClass(temp, rh, wind) {
    let score = 0;

    // Temperature scoring
    if (temp >= 80) score += 2;
    else if (temp >= 70) score += 1;

    // Relative Humidity scoring
    if (rh < 20) score += 3;
    else if (rh < 30) score += 2;
    else if (rh < 40) score += 1;

    // Wind scoring
    if (wind >= 18) score += 2;
    else if (wind >= 12) score += 1;

    // Convert score to 4-level fire danger class (1: Low, 2: Moderate, 3: High, 4: Extreme)
    if (score <= 2) return 1;
    if (score <= 5) return 2;
    if (score <= 8) return 3;
    return 4;
}

// Render county cards with danger labels and classes
function renderCountyCards(counties) {
    const countyGrid = document.getElementById('countyGrid');
    countyGrid.innerHTML = '';

    // Four-level fire danger labels: Low, Moderate, High, Extreme
    const dangerLabels = ['Low', 'Moderate', 'High', 'Extreme'];

    counties.forEach(county => {
        // If danger class isn't provided, calculate based on temp, RH, and wind
        // Determine danger class, clamping to valid range 1-4
        const rawClass = county.dangerClass || calculateDangerClass(county.temp, county.rh, county.wind);
        const dangerClass = Math.max(1, Math.min(rawClass, dangerLabels.length));
        const label = dangerLabels[dangerClass - 1] || 'N/A';

        const card = document.createElement('div');
        card.className = 'county-card';

        card.innerHTML = `
          <div class="danger-bubble class-${dangerClass}" title="${label}">
            ${dangerClass}
          </div>
          <div class="county-name">${county.name} County</div>
          <div class="county-data">
            <div class="data-row">
              <span class="data-label">Temp</span>
              <span class="data-value">${county.temp}¬∞F</span>
            </div>
            <div class="data-row">
              <span class="data-label">RH</span>
              <span class="data-value">${county.rh}%</span>
            </div>
            <div class="data-row">
              <span class="data-label">Dew Pt</span>
              <span class="data-value">${county.dewPoint}¬∞F</span>
            </div>
            <div class="data-row">
              <span class="data-label">Wind</span>
              <span class="data-value">${county.wind} mph</span>
            </div>
            <div class="data-row">
              <span class="data-label">Gust</span>
              <span class="data-value">${county.gust} mph</span>
            </div>
            <div class="data-row">
              <span class="data-label">Danger</span>
              <span class="data-value">${label}</span>
            </div>
          </div>
        `;

        countyGrid.appendChild(card);
    });
}

// Update timestamp displayed in the header
function updateTimestamp(timestamp) {
    const lastUpdate = document.getElementById('lastUpdate');
    const date = new Date(timestamp);
    lastUpdate.textContent = date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
    });
}

// Refresh data and animate button
async function refreshData() {
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.style.animation = 'spin 1s linear';

    await loadCountyData();

    setTimeout(() => {
        refreshBtn.style.animation = '';
    }, 1000);
}

// Add spin animation to the document
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
    section {
      margin: 2rem auto; max-width: 1000px;
      background: #232323;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.14);
      padding: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0 0.5rem 0;
      background: #222;
      box-shadow: 0 0 8px rgba(0,0,0,0.08);
      border-radius: 8px;
    }
    td, th {
      padding: 10px 12px;
      border: 1px solid #3e3e3e;
      text-align: center;
    }
    th {
      background: #333;
      font-weight: bold;
      color: #fff;
    }
    .county {
      font-weight: 600;
      text-align: left;
      background: #2a2a2a;
    }
    /* Muted color classes for accessibility */
    .class-1 { background: #2d4a2d; color: #a8d5a8; font-weight: bold; } /* Muted dark green for Low */
    .class-2 { background: #5a4a2d; color: #e8c590; font-weight: bold; } /* Muted dark orange for Moderate */
    .class-3 { background: #5a2d2d; color: #f5a3a3; font-weight: bold; } /* Muted dark red for High */
    .class-4 { background: #4a1f1f; color: #ff8888; font-weight: bold; } /* Deep red for Very High */
    .class-5 { background: #3d0d0d; color: #ff6b6b; font-weight: bold; } /* Dark red for Extreme */
    .resources {
      margin-top: 2rem;
    }
    .resources ul {
      list-style: none;
      padding: 0;
    }
    .resources li {
      margin: 0.5rem 0;
    }
    .resources a {
      color: #4caf50;
      text-decoration: none;
      font-weight: bold;
    }
    .resources a:hover {
      color: #81c784;
      text-decoration: underline;
    }
    @media (max-width:768px) {
      section { padding:1rem; }
      h1 { font-size:1.3rem; }
      table td, table th { padding: 5px 8px; font-size: 0.85rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>üî• Five Forks Fire Weather Forecast</h1>
    <a class="back-link" href="index.html">‚Üê Back to Dashboard</a>
  </header>
  <section>
   
    <div class="resources">
      <h2>External Resources</h2>
      <ul>
        <li><a href="https://www.weather.gov/" target="_blank">National Weather Service (NWS)</a></li>
        <li><a href="https://www.dof.virginia.gov/" target="_blank">Virginia Department of Forestry (DOF)</a></li>
        <li><a href="https://www.wunderground.com/" target="_blank">Weather Underground</a></li>
        <li><a href="https://www.wfas.net/" target="_blank">Wildland Fire Assessment System (WFAS)</a></li>
        <li><a href="https://www.landfire.gov/" target="_blank">LANDFIRE</a></li>
        <li><a href="https://droughtmonitor.unl.edu/" target="_blank">U.S. Drought Monitor</a></li>
      </ul>
    </div>
  </section>
</body>
</html>
            </div>
        </section>

        </section>

        <!-- Footer -->
        <footer>
            <p>Last updated: <span id="lastUpdate">Loading...</span></p>
            <p class="data-note">Data updates every 6 hours ‚Ä¢ NWS + FIRMS</p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="dashboard.js"></script>
</body>
</html>
